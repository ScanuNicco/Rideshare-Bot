<!DOCTYPE html>
<html>
    <head>
        <title>Search | Rose Rideshares</title>
        <link rel="icon" href="slowlane.png"></link>
        <link rel="stylesheet" href="styles.css"></link>
        <link rel="stylesheet" href="search.css"></link>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
	<meta name="description" content="Search for a ride.">
    </head>
    <body>
        <div class="headerBar">
            <a href="/"><img src="slowlane_small.png"></a><input id="searchBar" placeholder="Search for a ride..." onkeypress="if (event.key == 'Enter') { searchNow(); }"></input><button onclick="searchNow()"><img src="search.svg"></button><button class="smolGlowyButton" onclick="location.href = 'https://discord.gg/nSraC7nYMm'"><img src="discord.svg"></button>
        </div>
        <iframe id="loading" src="loading.svg"></iframe>
        <div id="outerFilterCont">
            <div id="viewSelector">
                <img class="active" src="tileView.svg" onclick="showView(0)">
                <img src="calendarView.svg" onclick="showView(1)" class="">
                <img id="filterButton" src="filter.svg" onclick="toggleFilter()">
            </div>
            <div id="filterCont" onclick="generateHTML()">
            <h2>Filter Results</h2>
            <h3>Type</h3>
            <div class="checkCont">
                <input type="checkbox" class="styledCheckbox" checked id="offersBox"></input><label>Offers</label>
            </div>
            <div class="checkCont">
                <input type="checkbox" class="styledCheckbox" checked id="requestBox"></input><label>Requests</label>
            </div>
            <h3>Date Range</h3>
            <input type="datetime-local" class="styledInput" id="rangeStart" onchange="generateHTML()" style="width: calc(100% - 10px);"></input><br>
            <p style="margin:auto; text-align: center">To</p>
            <input type="datetime-local"  class="styledInput" id="rangeEnd" onchange="generateHTML()" style="width: calc(100% - 10px);"></input><br>
            <h3>Category</h3>
            <select id="catSelect" class="styledInput">
                <option value="">All Categories</option>
            </select>
            <button class="bigGlowyButton" onclick="resetFilter()">Reset</button>
        </div>
            <div id="rideViewsCont">
            <div id="tilesCont"></div>
            <div id="calendarCont"></div>
            </div>
        <div id="modalBackground">
            <button id="close" onclick="closeModal()">&times;</button>
            <div id="modal">
                <h1 id="rideModalHeader">Ride Request for ___</h1>
                <div id="statusBox">
                    <div id="statusLabel">Status:</div>
                    <div id="statusContent"></div>
                </div>
                <table>
                    <tr><td class="label">Date Posted:</td><td id="posted"></td></tr>
                    <tr><td class="label">Category:</td><td id="cat"></td></tr>
                    <tr><td class="label">User:</td><td id="user"></td></tr>
                    <tr><td class="label">Origin:</td><td id="from"></td></tr>
                    <tr><td class="label">Destination:</td><td id="dest"></td></tr>
                    <tr><td class="label">When:</td><td id="when"></td></tr>
                    <tr class="offerOnly"><td class="label">Vehicle:</td><td id="vehicle"></td></tr>
                    <tr><td class="label">Payment:</td><td id="payment"></td></tr>
                    <tr><td class="label">Additional Info:</td><td id="info"></td></tr>
                </table>
                <a id="goToMessage">
                    <button class="bigGlowyButton">View On Discord</button>
                </a>
            </div>
        </div>
        <script src="/fullcalendar/dist/index.global.min.js"></script>
        <script src="shared.js"></script>
        <script>


                var q;
                var rideEvents;
                var calenderEl;
                var calender;

                window.onload = async function() {
                    q = getUrlVars()['q'];
                    document.getElementById('searchBar').value = q;
                    //Intialize calendar
                    calendarEl = document.getElementById('calendarCont');
                    calendar = new FullCalendar.Calendar(calendarEl, {
                        initialView: 'dayGridMonth',
                        eventClick: showRideFromCal,
                        contentHeight: 'auto'
                    });
                    calendar.render();
                    //Populate categories and results
                    await search(q);
                    html = "";
                    for(var i = 0; i < rideEvents[2].length; i++){
                        html += `<option>${rideEvents[2][i]}</option>`;
                    }
                    document.getElementById("catSelect").innerHTML += html;
                    resetFilter();
                    changeViewCaledar()

                    window.addEventListener("resize", () => {
                        changeViewCaledar()
                    });
                }

                const changeViewCaledar = () => {
                    if (document.body.clientWidth < 600) {
                        calendar.changeView("listMonth");
                    } else {
                        calendar.changeView("dayGridMonth");
                    }
                }

                async function search(q) {
                    const result = await fetch('/api/query', {
                        method: 'POST',
                        body: JSON.stringify({Query: q}),
                        headers: {"Content-type": "application/json"}
                    });
                    const json = await result.json();
                    console.log(json);
                    rideEvents = json;
                    generateHTML();
                }

                function searchNow() {
                    document.getElementById("loading").style.display = 'block';
                    document.getElementById("filterCont").style.display = 'none';
                    document.getElementById("tilesCont").innerHTML = "";
                    var query = document.getElementById("searchBar").value;
                    search(query);
                    window.history.pushState('page2', 'Title', '/search.html?q=' + query);
                }

                function generateHTML() {
                    html = "";
                    if(document.getElementById("offersBox").checked){
                        calendar.removeAllEvents();
                        for(off in rideEvents[1]) {
                            re = rideEvents[1][off];
                            if(passesFilters(re)){
                                var date = new Date(re.when).toLocaleString();
                                re.dateObj = date;
                                html += `<div class='rideCard' onclick="showOffer(${off})"><div class='leftCol'><img src=${re.target.avatarURL}><h4>${re.target.username}</h4></div><div class='rightCol'><h2>Ride Offer to ${trimToLength(re.destName)}</h2><span><b>From:</b> ${re.whenceName ?? 'Rose-Hulman'}</span><span><b>When:</b> ${date}</span><span><b>Vehicle:</b> ${re.vehicleInfo}</span></div></div>`;
                                calendar.addEvent({
                                    title: re.destName,
                                    start: re.when,
                                    extendedProps: {type: "offer", index: off},
                                    color: "rgb(137, 220, 137)"
                                });
                            }
                        }
                        //calendar.render();
                    }
                    if(document.getElementById("requestBox").checked){
                        for(req in rideEvents[0]) {
                            re = rideEvents[0][req];
                            if(passesFilters(re)){
                                var date = new Date(re.when).toLocaleString();
                                re.dateObj = date;
                                html += `<div class='rideCard' onclick="showRequest(${req})"><div class='leftCol'><img src=${re.target.avatarURL ?? "noPic.svg"}><h4>${re.target.username}</h4></div><div class='rightCol'><h2>Ride Request for ${trimToLength(re.destName)}</h2><span><b>From:</b> ${re.whenceName ?? 'Rose-Hulman'}</span><span><b>When:</b> ${date}</span></div></div>`;
                                calendar.addEvent({
                                    title: re.destName,
                                    start: re.when,
                                    extendedProps: {type: "request", index: req},
                                    color: "rgb(87, 189, 220)"
                                });
                            }
                        }
                    }
                    document.getElementById("tilesCont").innerHTML = html;
                    document.getElementById("loading").style.display = 'none';
                }

                function trimToLength(string) {
                    if(string.length > 25) {
                        return string.substring(0, 22) + "...";
                    }
                    return string;
                }

                function passesFilters(re) {
                    var start = Number.MIN_SAFE_INTEGER;
                    var end = Number.MAX_SAFE_INTEGER;
                    if(document.getElementById("rangeStart").value != "") {
                        start = new Date(document.getElementById("rangeStart").value).getTime();
                    }
                    if(document.getElementById("rangeEnd").value != "") {
                        end = new Date(document.getElementById("rangeEnd").value).getTime();
                    }
                    return !re.deleted && re.when <= end && re.when >= start && re.cat.includes(document.getElementById('catSelect').value);
                }

                function showOffer(off) {
                    var offer = rideEvents[1][off];
                    showRideEvent(offer);
                    for(var i = 0; i < document.getElementsByClassName("offerOnly").length; i++){
                        document.getElementsByClassName("offerOnly")[i].style.display = "";
                    }
                    document.getElementById("payment").innerText = offer.payment ? offer.target.username + " is excpecting payment to help cover gas/parking" : "Not requested.";
                    document.getElementById("vehicle").innerText = offer.vehicleInfo;
                    document.getElementById("rideModalHeader").innerText = "Ride Offer to " + offer.destName;
                    openModal();
                }

                function showRequest(req) {
                    var request = rideEvents[0][req];
                    showRideEvent(request);
                    document.getElementById("payment").innerText = request.payment ? request.target.username + " is offering payment to help cover gas/parking" : "Not offering payment.";
                    for(var i = 0; i < document.getElementsByClassName("offerOnly").length; i++){
                        document.getElementsByClassName("offerOnly")[i].style.display = "none";
                    }
                    document.getElementById("rideModalHeader").innerText = "Ride Request for " + request.destName;
                    openModal();
                }

                function showRideEvent(re) {
                    document.getElementById("posted").innerText = new Date(re.timestamp).toLocaleString();
                    document.getElementById("cat").innerText = re.cat;
                    document.getElementById("user").innerText = re.target.globalName + " (@" + re.target.username + ")";
                    document.getElementById("dest").innerText = re.dest.properties.geocoding.label;
                    document.getElementById("from").innerText = re.whence.properties.geocoding.label ?? "Rose-Hulman Institute of Technology";
                    document.getElementById("when").innerText = re.dateObj.toLocaleString();
                    document.getElementById("info").innerText = re.info ?? "None";
                    document.getElementById("goToMessage").href = `https://discord.com/channels/${re.message.guildId}/${re.message.channelId}/${re.message.id}`;
                    document.getElementById("statusContent").innerText = re.status ?? "No status";
                }

                function closeModal() {
                    document.getElementById("modalBackground").style.top = "100vh";
                    document.getElementById("modalBackground").style.borderRadius = "100px";
                }

                function openModal() {
                    document.getElementById("modalBackground").style.top = "0vh";
                    document.getElementById("modalBackground").style.borderRadius = "0px";
                }

                function resetFilter() {
                    var now = new Date();
                    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                    document.getElementById("rangeStart").value = now.toISOString().slice(0,16);
                    document.getElementById("rangeEnd").value = "";
                    document.getElementById("offersBox").checked = true;
                    document.getElementById("requestBox").checked = true;
                    document.getElementById("catSelect").value = "";
                    generateHTML();
                }

                var views = ["tilesCont", "calendarCont"]; //Add view IDs to this list in the order the appear in the selector
                function showView(id) {
                    var viewSelectCont = document.getElementById("viewSelector");
                    for(var i = 0; i < views.length; i++){
                        document.getElementById(views[i]).style.display = "none";
                        viewSelectCont.children[i].classList.remove("active");
                    }
                    document.getElementById(views[id]).style.display = "flex";
                    viewSelectCont.children[id].classList.add("active");
                    calendar.render();
                }

                function toggleFilter() {
                    var filterCont = document.getElementById("filterCont");
                    var filterButton = document.getElementById("filterButton");
                    if(filterCont.style.display == "none"){
                        filterCont.style.display = "block"
                        filterButton.classList.add("active");
                    } else {
                        filterCont.style.display = "none"
                        filterButton.classList.remove("active");
                    }
                    calendar.render();
                }

                function showRideFromCal(info) {
                    console.log(info);
                    console.log(info.event.extendedProps.type)
                    if(info.event.extendedProps.type == "offer"){
                        showOffer(info.event.extendedProps.index);
                    } else {
                        showRequest(info.event.extendedProps.index);
                    }
                }

            </script>
        </body>
    </html>
